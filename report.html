<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reports ‚Äì Meena Chitfunds</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #121212;
      color: #fff;
      padding-bottom: 100px;
    }
    header {
      background: #1f1f1f;
      padding: 1rem;
      text-align: center;
      font-size: 1.4rem;
      font-weight: bold;
      color: #00bcd4;
    }
    nav {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      background: #1c1c1c;
      padding: 0.5rem;
      border-bottom: 1px solid #333;
    }
    nav button {
      flex: 1 1 45%;
      margin: 0.25rem;
      padding: 0.75rem;
      border: none;
      background: #2a2a2a;
      color: #ccc;
      font-weight: 500;
      border-radius: 6px;
      cursor: pointer;
    }
    nav button:hover {
      background: #333;
      color: #00e6e6;
    }
    .container {
      padding: 1rem;
    }
    label, select, input {
      display: block;
      width: 100%;
      margin: 1rem 0 0.5rem;
    }
    select, input {
      padding: 0.7rem;
      background: #1e1e1e;
      border: 1px solid #333;
      border-radius: 8px;
      color: #fff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      padding: 0.7rem;
      border-bottom: 1px solid #333;
      text-align: left;
    }
    th {
      background: #1f1f1f;
      color: #00e6e6;
    }
    .export-btn {
      background: #2a2a2a;
      color: #00e6e6;
      border: none;
      padding: 0.8rem;
      border-radius: 8px;
      margin-top: 1rem;
      width: 100%;
      cursor: pointer;
      font-weight: bold;
    }
    .export-btn:hover {
      background: #333;
    }
    #chartSection {
      margin-top: 2rem;
      background: #1c1c1c;
      padding: 1rem;
      border-radius: 10px;
    }
    canvas {
      max-width: 100%;
    }
    footer {
      text-align: center;
      padding: 1rem;
      background: #1c1c1c;
      color: #888;
      position: fixed;
      width: 100%;
      bottom: 0;
    }
  </style>
</head>
<body><header>üìä Group Reports ‚Äì Meena Chitfunds</header><nav>
  <button onclick="location.href='index.html'">üè† Dashboard</button>
  <button onclick="location.href='add-group.html'">‚ûï Add Group</button>
  <button onclick="location.href='add-member.html'">üë§ Add Member</button>
  <button onclick="location.href='add-payment.html'">üí∏ Add Payment</button>
</nav><div class="container">
  <label>Select Group</label>
  <select id="groupSelect" onchange="renderChart()">
    <option value="">-- Select Group --</option>
  </select><button class="export-btn" onclick="exportPDF()">üì§ Export PDF Report</button>

  <div id="chartSection">
    <h3>üìà Group Payment Overview</h3>
    <canvas id="groupChart"></canvas>
  </div>
</div><footer>Powered by Goorac ¬∑ Meena Chitfunds</footer><script>
  let data = { groups: [] };

  function loadGroups() {
    const raw = localStorage.getItem('chitData');
    if (raw) {
      data = JSON.parse(raw);
      const select = document.getElementById('groupSelect');
      data.groups.forEach(group => {
        const option = document.createElement('option');
        option.value = group.id;
        option.textContent = group.name;
        select.appendChild(option);
      });
    }
  }

  function renderChart() {
    const groupId = document.getElementById('groupSelect').value;
    const group = data.groups.find(g => g.id === groupId);
    if (!group || !group.members) return;

    const labels = group.members.map(m => m.name);
    const totals = group.members.map(m =>
      (m.amountPaid || 0) + (m.payments || []).reduce((sum, p) => sum + p.amount, 0)
    );

    const ctx = document.getElementById('groupChart').getContext('2d');
    if (window.chartInstance) window.chartInstance.destroy();
    window.chartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Total Paid (‚Çπ)',
          data: totals,
          backgroundColor: '#00bcd4'
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: { callbacks: { label: ctx => `‚Çπ${ctx.raw}` } }
        }
      }
    });
  }

  function exportPDF() {
    const groupId = document.getElementById('groupSelect').value;
    const group = data.groups.find(g => g.id === groupId);
    if (!group) return;

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const totalMonths = group.monthlyAmounts?.length || group.totalMonths || 20;

    doc.setFontSize(18);
    doc.text("Meena Chitfunds", 14, 14);
    doc.setFontSize(12);
    doc.text(`Group: ${group.name}`, 14, 22);
    doc.text(`Exported: ${new Date().toLocaleString()}`, 14, 28);

    const tableHead = [["Name", "Phone", "Place", "Paid (‚Çπ)", "Remaining (‚Çπ)", "Last Due", "Status"]];
    const tableBody = [];

    group.members.forEach(member => {
      const totalPaid = (member.amountPaid || 0) + (member.payments || []).reduce((s, p) => s + p.amount, 0);
      const lastDue = member.payments?.length > 0 ? member.payments[member.payments.length - 1].due : 0;
      const expected = group.monthlyAmounts?.slice(0, totalMonths).reduce((a, b) => a + b, 0) || 0;
      const remaining = expected - totalPaid;

      tableBody.push([
        member.name,
        member.phone || '-',
        member.place || '-',
        `‚Çπ${totalPaid}`,
        `‚Çπ${remaining < 0 ? 0 : remaining}`,
        lastDue || '-',
        remaining > 0 ? 'Unpaid' : 'Paid'
      ]);
    });

    doc.autoTable({
      startY: 32,
      head: tableHead,
      body: tableBody,
      styles: {
        fontSize: 10,
        cellPadding: 3,
        fillColor: [30, 30, 30],
        textColor: 255,
        lineColor: [70, 70, 70]
      },
      headStyles: { fillColor: [0, 188, 212] },
      alternateRowStyles: { fillColor: [18, 18, 18] },
    });

    doc.save(`MeenaChitfunds_${group.name}_Report.pdf`);
  }

  loadGroups();
</script></body>
</html>
